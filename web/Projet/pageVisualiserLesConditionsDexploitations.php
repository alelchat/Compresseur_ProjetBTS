<!-- ÉTUDIANT 1 -->
<!DOCTYPE html>
<html lang="fr">
    <?php
        require('autre/accesBDD.php');
        include('autre/pageBase.php');

        require ('autre/script/scriptEtatNouvelleAlerte.php');//NOUVELLE ALERTE -------------------
        $etatAlerte = getEtatNouvelleAlerte();//NOUVELLE ALERTE -------------------

        $monPlusRecent = getPlusRecent(1);
        $monTonPlusRecent = getPlusRecentTon(1);
        $monToffPlusRecent = getPlusRecentToff(1);
        $monEtatCompresseur = getEtatMarche();
        $debutMarcheStr = getHeureDebutMarcheCompresseur();
        $debutMarcheReel = implode(": ",$debutMarcheStr[0]);
        $debutMarcheTime = strtotime($debutMarcheReel);
        $valeurActuelle = time();
        $diff = dateDiff($debutMarcheTime,$valeurActuelle);
        $coucou = implode(", ",$diff);
        $maSeconde = $diff['second'];
        $maMinute = $diff['minute'];
        $monHeure = $diff['hour'];
        $monJour = $diff['day'];

        echo '
        <head>
        <meta charset="UTF-8">
        <meta http-equiv="Refresh" content="20">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta http-equiv="X-UA-Compatible" content="ie=edge">
        <link rel="stylesheet" href="autre/css/pageDeBase.css">
        <link rel="stylesheet" href="autre/css/cssCompresseur.css">
        <title>Visualiser les conditions d\'exploitations</title>
        </head>
        
        
        <script>
        function nouvelleAlerte(){//NOUVELLE ALERTE -------------------
            // Effectue une requête AJAX vers le script PHP
            var xhr = new XMLHttpRequest();
            xhr.open(\'POST\', \'autre/script/scriptNouvelleBulleAlerte.php\', true);
            xhr.onreadystatechange = function () {
              if (xhr.readyState === 4 && xhr.status === 200) {
                // Traitement de la réponse du script PHP (optionnel)
                var reponse = xhr.responseText;
                console.log(reponse);
              }
            };
            xhr.send();
            }
      function bulleAlerte(alerteVal){//NOUVELLE ALERTE -------------------
        // Effectue une requête AJAX vers le script PHP
        var xhr = new XMLHttpRequest();
        xhr.open(\'POST\', \'autre/script/scriptEtatNouvelleAlerte.php\', true);
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4 && xhr.status === 200) {
            // Traitement de la réponse du script PHP (optionnel)
            var reponse = xhr.responseText;
            console.log(reponse);
            window.location.href="pageControlerSysteme.php"; 
          }
        };
        xhr.send(alerteVal);
        }        
        </script>';

        for($i = 0; $i < 1; ++$i)//NOUVELLE ALERTE -------------------
        {//NOUVELLE ALERTE -------------------
            echo '<script>nouvelleAlerte()</script>';//NOUVELLE ALERTE -------------------
        }//NOUVELLE ALERTE -------------------
        if($etatAlerte == 1)//NOUVELLE ALERTE -------------------
        {//NOUVELLE ALERTE -------------------
            echo '<img class="alerteImages" src="autre/images/alerte.png">
            <input type="submit" onclick="bulleAlerte(404)" class="leBoutonNouvelleAlerte" id="boutonNouvelleAlerte" name="boutonTest" value="Nouvelle alerte !" value="">';
        }//NOUVELLE ALERTE -------------------
        else
        {
            echo'
            <body>
                <CENTER>
                <table style="border-spacing: 30px";> 
                    <tr>
                        <th><h2 class="second_titre"> Pression actuelle</h2></th>    
                        <th><h2 class="second_titre">Temps de fonctionnement du compresseur</h2></th>
                        <th><h2 class="second_titre">Purge</h2> </th>
                    </tr>
                    <tr>
                    <td><h3 class="afficher_donnees">'.$monPlusRecent[0]['donnee'].' Bar</h3></td>
                    
                    <td><h3 class="afficher_donnees">';
                    $etatMarche = -1;
                    if(isset($monEtatCompresseur[0]['etatMarche'])){
                            $etatMarche = $monEtatCompresseur[0]['etatMarche'];
                        }
                    if ($etatMarche == 1){
                            echo "{$monJour}J {$monHeure}H {$maMinute}m {$maSeconde}s";
                        }
                    else if($etatMarche == 0){ 
                            echo "Compresseur éteint";
                        }
                    else if($etatMarche == -1){
                            echo "Probleme de recuperation de l'etat";
                        }
                    else{
                            echo "Probleme de l'état du compresseur";   
                        }
                    echo '</h3></td>
                    
                    
                    <td>
                    <div class="purge">
                        <form action="pageVisualiserLesConditionsDexploitations.php" method="POST">
                            <label for="tonActuelle"><b>Ton actuelle</b></label><br>
                            <input type="number" name="tonActuelle" id="tonActuelle" value="'.$monTonPlusRecent[0]['t_ON'].'" disabled="disabled" /> secondes <br><br>
                            <label for="tonModif"><i>Changement du temps de la purge</i></label> <br>
                            <input type="number" name="tonModif" id="tonModif" value=""/> <br><br>
                            <label for="toffActuelle"><b>Toff actuelle</b></label><br>
                            <input type="number" name="toffActuelle" id="toffActuelle" value="'.$monToffPlusRecent[0]['t_OFF'].'" disabled="disabled" /> minutes <br><br>
                            <label for="toffModif"><i>Changement du délai de répétition</i></label> <br>
                            <input type="number" name="toffModif" id="toffModif" value=""/><br><br>
                            <input type="submit" value="Valider"/><br>
                        </form>';

                        if((!empty($_POST['tonModif']) == true) && (!empty($_POST['toffModif']) == true))
                                {
                                    $tonModif = $_POST['tonModif']; 
                                    $toffModif = $_POST['toffModif'];
                                    setTon($tonModif);
                                    setToff($toffModif);
                                }
                            else if((!empty($_POST['tonModif']) == true) && (!empty($_POST['toffModif']) == false))
                                {
                                    $tonModif = $_POST['tonModif'];
                                    setTon($tonModif);
                                }
                            else if((!empty($_POST['tonModif']) == false) && (!empty($_POST['toffModif']) == true))
                                {
                                    $toffModif = $_POST['toffModif'];
                                    setToff($toffModif);
                                }
                                echo '</div></h3>
                                </td>
                        </tr>
                        <tr>
                            <td><button class="boutonVert" onclick="location.href=\'pageEstimation.php\'"><span style ="font-weight: bold;">Visualiser l\'estimation des consommations</span></button></td>
                            <td><button class="boutonVert" onclick="location.href=\'pageMenu.php\'"><span style ="font-weight: bold;">Retour</span></button></td>
                            <td><button class="boutonVert" onclick="location.href=\'pageHistoriqueDesMesures.php\'"><span style ="font-weight: bold;">Visualiser l\'historique des mesures</span></button></td>
                        </tr>
                    </table>
                    <CENTER>
                </body>
            </html>';
        }//NOUVELLE ALERTE -------------------
    ?>
    
    
                
                        